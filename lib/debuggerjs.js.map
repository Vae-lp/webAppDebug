{"version":3,"sources":["../src/debuggerjs.js"],"names":["DebuggerInstance","error","instance","errLocation","create","sendErrorData","me","needShow","style","parseCSS","count","Debugger","errorCount","timeStamp","Date","content","contentCss","message","location","alertBox","document","createElement","id","wrapCss","innerHTML","body","appendChild","setTimeout","destroy","blur","then","parentNode","removeChild","timer","Promise","res","rej","setInterval","opacity","getCssValue","clearTimeout","needReport","url","method","errorObj","href","ua","navigator","userAgent","filename","getFileName","lineno","getLineNo","colno","getColNo","getLocation","data","target","attr","window","getComputedStyle","splitLocation","replace","rs","exec","RE","RegExp","$1","$2","$3","locationObj","obj","cssText","key","cssKey","toLowerCase","cssVal","confData","init","options","addEventListener","listenScriptError","log","arguments","isError","getStackMessage","stack","getStackLocation","isEvent","throwError","src","e","isErrorEvent","isXHR","isString","isUndefined","Error","stackArr","split","length","constructor","Event","ErrorEvent","isProgressEvent","ProgressEvent","XMLHttpRequest","Object","prototype","toString","call"],"mappings":"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","file":"debuggerjs.js","sourcesContent":["/**\n * Created by didi on 16/9/21.\n */\nimport ajax from '@fdaciuk/ajax';\nimport objectAssign from 'object-assign';\n\nclass DebuggerInstance {\n    constructor(error) {\n        this.instance = null;\n        this.errLocation = {};\n        this.create(error);\n        this.sendErrorData(error);\n\n    }\n\n    create(error) {\n        let me = this;\n        if (!error.needShow) return;\n\n        let style = me.parseCSS();\n        let count = Debugger.errorCount;\n        let timeStamp = +new Date();\n        let content = `\n            <div style=\"${style.contentCss}\">err${count}: ${error.message}<br/>location: ${error.location}</div>\n            `;\n        let alertBox = document.createElement('div');\n        alertBox.id = 'debugger-' + timeStamp;\n        alertBox.style = style.wrapCss;\n        alertBox.innerHTML = content;\n\n        me.instance = alertBox;\n\n        document.body.appendChild(alertBox);\n\n        Debugger.errorCount++;\n\n        setTimeout(function () {\n            me.destroy();\n        }, 10000)\n    }\n\n    destroy() {\n        let me = this;\n        me.blur()\n            .then(function () {\n                let instance = me.instance;\n                instance && instance.parentNode && instance.parentNode.removeChild(instance);\n            })\n    }\n\n    blur() {\n        let me = this,\n            instance = this.instance,\n            timer = null;\n\n        return new Promise(function (res, rej) {\n            timer = setInterval(function () {\n                let opacity = me.getCssValue(instance, 'opacity');\n                if (opacity < 0.1) {\n                    clearTimeout(timer);\n                    res()\n                } else {\n                    instance.style.opacity = opacity - 0.1\n                }\n            }, 50)\n        });\n\n    }\n\n    sendErrorData(error) {\n        if (!error.needReport) return;\n\n        const url = error.url;\n        const method = error.method;\n\n        let errorObj = {\n            url: location.href,\n            ua: navigator.userAgent,\n            filename: error.filename || this.getFileName(error.location),\n            lineno: error.lineno || this.getLineNo(error.location),\n            colno: error.colno || this.getColNo(error.location),\n            message: error.message || '',\n            location: this.getLocation(error.location) || ''\n        };\n        ajax({\n            url: url,\n            method: method,\n            data: errorObj\n        })\n    }\n\n    parseCSS(){\n        let wrapCss, contentCss;\n        wrapCss = \"position: relative; opacity: 1; word-wrap: break-word;\";\n        contentCss = \"background: rgba(0, 0, 0, 0.6);font-size: 1rem;color: #fff;line-height: 1.2;padding: 0.5rem 10% 0.5rem 0.5rem;border-bottom: 1px solid #f0f0f0;\";\n        return {wrapCss, contentCss}\n    }\n    getCssValue(target, attr) {\n        return window.getComputedStyle(target)[attr]\n    }\n\n    getFileName(location) {\n        return this.errLocation.filename ? this.errLocation.filename : this.splitLocation(location).filename\n    }\n\n    getLineNo(location) {\n        return this.errLocation.lineno ? this.errLocation.lineno : this.splitLocation(location).lineno\n    }\n\n    getColNo(location) {\n        return this.errLocation.colno ? this.errLocation.colno : this.splitLocation(location).colno\n    }\n\n    getLocation(location) {\n        return location.replace(/\\s*(\\(.*\\))\\s*/, '')\n    }\n\n    splitLocation(location) {\n        const rs = /^.*\\((.*\\.js):(\\d*):(\\d*)\\)/.exec(location);\n        const RE = RegExp;\n        let [filename,lineno,colno] = [RE.$1, RE.$2, RE.$3];\n        this.locationObj = {filename, lineno, colno} // for cache\n        return this.locationObj\n    }\n\n    compileToCss(obj) {\n        let cssText = '';\n        for (let key in obj) {\n            let cssKey = key.replace(/([A-Z])/g, \"-$1\").toLowerCase();\n            let cssVal = obj[key];\n            cssText += (cssKey + ':' + cssVal + ';')\n        }\n\n        return cssText;\n    }\n}\nconst Debugger = {\n\n    errorCount: 1,\n\n    confData: {\n        needShow: true,\n        needReport: false,\n        method: 'post',\n        url: ''\n    },\n\n    init(options) {\n        let me = this;\n\n        if (options) {\n            me.confData = objectAssign(me.confData, options)\n        }\n        window.addEventListener('load',function () {\n            me.listenScriptError();\n        })\n    },\n\n    listenScriptError(){\n        let me = this;\n        window.addEventListener('error', function () {\n            me.log(arguments[0])\n        });\n    },\n    log(error){\n\n        let me = this;\n\n        error = objectAssign(error, me.confData);\n\n        if (me.isError(error)) {\n\n            error.message = me.getStackMessage(error.stack);\n            error.location = me.getStackLocation(error.stack);\n            new DebuggerInstance(error);\n\n        } else if (me.isEvent(error)) {\n            me.throwError()\n                .then(e => {\n                    var target = error.target;\n                    error.message = \"Resource Error: can't get \" + (target.src || target.href) + \".\";\n                    error.location = me.getStackLocation(e.stack);\n                    new DebuggerInstance(error);\n                });\n\n\n        } else if (me.isErrorEvent(error)) {\n\n            error.location = me.getStackLocation(error.error.stack);\n            new DebuggerInstance(error);\n\n        } else if (me.isXHR(error)) {\n\n            me.throwError()\n                .then(e => {\n                    error.message = \"AJAX Error: XMLHttpRequest failed. Did you use $.ajax? the Debugger can't get more detail from error callback. Please check your $.ajax settings.\"\n                    error.location = me.getStackLocation(e.stack);\n                    new DebuggerInstance(error);\n\n                })\n\n        } else if (me.isString(error)) {\n            me.throwError()\n                .then(e => {\n                    new DebuggerInstance({\n                        message: error,\n                        location: me.getStackLocation(e.stack)\n                    });\n                })\n\n        } else if (me.isUndefined(error)) {\n            me.throwError()\n                .then(e => {\n                    error.message = \"Params Error: Debugger.log(...) must have 1 param in it, but found none\";\n                    error.location = me.getStackLocation(e.stack);\n                    new DebuggerInstance(error);\n\n                });\n        } else {\n            me.throwError()\n                .then(e => {\n                    error.message = \"Unknown Error.\";\n                    error.location = me.getStackLocation(e.stack);\n                    new DebuggerInstance(error);\n                });\n        }\n    },\n    throwError(){\n        return new Promise(function (res, rej) {\n            try {\n                throw new Error();\n            } catch (e) {\n                res(e)\n            }\n        })\n\n    },\n    getStackMessage(stack){\n        let stackArr = stack.split(/\\n+/);\n        return stackArr[0].replace(/(^\\s+|\\s+$)/, \"\");\n    },\n    getStackLocation(stack){\n        let stackArr = stack.split(/\\n+/);\n        return stackArr[stackArr.length - 1].replace(/(^\\s+|\\s+$)/, \"\");\n    },\n    isError(error){\n        return error instanceof Error;\n    },\n    isEvent(error){\n        return error.constructor === Event;\n    },\n    isErrorEvent(error){\n        return error.constructor === ErrorEvent;\n    },\n    isProgressEvent(error){\n        return error.constructor === ProgressEvent;\n    },\n    isXHR(error){\n        return error.constructor === XMLHttpRequest;\n    },\n    isString(error){\n        return Object.prototype.toString.call(error) === \"[object String]\"\n    },\n    isUndefined(error){\n        return Object.prototype.toString.call(error) === \"[object Undefined]\"\n    }\n\n};\nexport default Debugger;"]}